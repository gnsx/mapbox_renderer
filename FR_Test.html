<!DOCTYPE html>
<html>
<head>
<meta charset=utf-8 />
<title>Leaflet Label</title>
<meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src='https://api.mapbox.com/mapbox.js/v2.2.3/mapbox.js'></script>
<link href='https://api.mapbox.com/mapbox.js/v2.2.3/mapbox.css' rel='stylesheet' />
<style>
  body { margin:0; padding:0; }
  #map { position:relative;height:700px ;top:0; bottom:0; width:100%; }
</style>

<script>
$(window).resize(function() {
   $('#map').height($(window).height() / 1.1);
});

$(window).trigger('resize');

</script>

<script> $(window).ready(function() { $('#map').height($(window).height() / 1.1); }); </script>


</head>
<body>
<script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-label/v0.2.1/leaflet.label.js'></script>
<link href='https://api.mapbox.com/mapbox.js/plugins/leaflet-label/v0.2.1/leaflet.label.css' rel='stylesheet' />
<div id='map'></div>

<input type='file' accept='text/plain' onchange='openFile(event)'><br>
<img id='output'>
<script>

  
    L.mapbox.accessToken = 'pk.eyJ1IjoicGVnYXN1cyIsImEiOiJjaWd1bjlvdmIwN3Izd3dtMDluYW1lMGlrIn0.QTR6xEpvu5bsXGeYn5jgjg';
    var map = L.mapbox.map('map', 'mapbox.streets', {
        center: [21.162672, 79.087958], 
        zoom: 5
    });
	
  var openFile = function(event) {
    var input = event.target;

    var reader = new FileReader();
    reader.onload = function(){
		
      var text = reader.result;
      var line_points = [];
	  
      var res = text.split("\n");
		console.log("Length of file " + res.length);
      for(i=0;i<res.length;i++)
      {
	  console.log("Pass" + i );

        if(res[i]!="")
        {
		
			
		
        var inside_array = res[i].split(",");
		
		/*if(x_first_pass === true)
			{
				
				angle_x = inside_array[1];
				angle_y = inside_array[2];
				x_first_pass = false;
			}
			*/
		//var arr1 = new L.LatLng(kalmanFilterX(inside_array[1],0.00000001), kalmanFilterY(inside_array[2],0.00000001));
		var arr1 = new L.LatLng(inside_array[1], inside_array[2]);
		console.log("Lat:" + inside_array[1] + "Lon " + inside_array[2]);
        line_points.push(arr1);
		
        }
        
      }
      var polyline_options = {  color: '#000' };
			L.polyline(line_points).addTo(map);
			

    };
    reader.readAsText(input.files[0]);
	
	
	
	var x_first_pass = true;
	var y_first_pass = true;
	
	
	var Q_angle_x    = 0.001;
	var Q_bias_x   = 0.000001; 
	var R_measure_x  = 0.95;  //0.03
	var bias_x = 0;
	//var P_x [2] [2];
	var P_x = [[0.0,0.0],[0.0,0.0]];
	var dt1 = 0.004;
	var K_x = [0.0,0.0];
	var  angle_x = 15.382528;//15.5018330;//new Number(0.0); //15.5018330
	var q_bias_x = 0.0;
	var rate_x = 0.0;
	var y_x = 0.0,S_x = 0.0;
	
	
	var Q_angle_y    = 0.001;
	var Q_bias_y   = 0.000001; 
	var R_measure_y  = 0.95;  //0.03
	var bias_y = 0;
	//var P_x [2] [2];
	var P_y = [[0.0,0.0],[0.0,0.0]];
	
	var K_y = [0.0,0.0];
	var  angle_y = 74.141558;//73.8246320; //new Number(0.0); //73.8246320;
	var q_bias_y = 0.0;
	var rate_y = 0.0;
	var y_y = 0.0,S_y = 0.0;
	
	var kalmanFilterX = function(newAngle_x, newRate_x){
	console.log(x_first_pass);
	/*if(x_first_pass)
		{
		//angle_x = newAngle_x;
		console.log(angle_x);
		x_first_pass=false;
		return(angle_x);
		}*/
	//else{
	
	/* Step 1 */
        
		
		rate_x = newRate_x - bias_x;
        
		angle_x = angle_x + (dt1 * rate_x);
        
		//console.log("P00:" + P_x[0
		
		
		/* Step 2 */
        P_x[0][0] += dt1 * (dt1*P_x[1][1] - P_x[0][1] - P_x[1][0] + Q_angle_x);
		
		
        P_x[0][1] -= dt1 * P_x[1][1];
        P_x[1][0] -= dt1 * P_x[1][1];
        P_x[1][1] += Q_bias_x * dt1;
           /* Step 3 */
       	y_x = newAngle_x - angle_x;
		   /* Step 4 */
        S_x = P_x[0][0] + R_measure_x;
        /* Step 5 */
        K_x[0] = P_x[0][0] / S_x;
        K_x[1] = P_x[1][0] / S_x;
        
        
        y_x = newAngle_x - angle_x;
        /* Step 6 */
        angle_x += K_x[0] * y_x;
        bias_x  += K_x[1] * y_x;        
        /* Step 7 */
        P_x[0][0] -= K_x[0] * P_x[0][0];
        P_x[0][1] -= K_x[0] * P_x[0][1];
        P_x[1][0] -= K_x[1] * P_x[0][0];
        P_x[1][1] -= K_x[1] * P_x[0][1];
        
		
		return(angle_x);
	//}
	
	
	};
	
	
	
	var kalmanFilterY = function(newAngle_y, newRate_y){
	
	console.log(y_first_pass);
	/*if(y_first_pass)
		{
		//angle_y = newAngle_y;
		console.log(newAngle_y);
		y_first_pass=false;
		return(angle_y);
		}
		else{**/
	
	/* Step 1 */
        rate_y = newRate_y - bias_y;
        
		angle_y = angle_y + (dt1 * rate_y);
        
		//console.log("P00:" + P_y[0
		
		
		/* Step 2 */
        P_y[0][0] += dt1 * (dt1*P_y[1][1] - P_y[0][1] - P_y[1][0] + Q_angle_y);
		
		
        P_y[0][1] -= dt1 * P_y[1][1];
        P_y[1][0] -= dt1 * P_y[1][1];
        P_y[1][1] += Q_bias_y * dt1;
           /* Step 3 */
       	y_y = newAngle_y - angle_y;
		   /* Step 4 */
        S_y = P_y[0][0] + R_measure_y;
        /* Step 5 */
        K_y[0] = P_y[0][0] / S_y;
        K_y[1] = P_y[1][0] / S_y;
        
        
        y_y = newAngle_y - angle_y;
        /* Step 6 */
        angle_y += K_y[0] * y_y;
        bias_y  += K_y[1] * y_y;        
        /* Step 7 */
        P_y[0][0] -= K_y[0] * P_y[0][0];
        P_y[0][1] -= K_y[0] * P_y[0][1];
        P_y[1][0] -= K_y[1] * P_y[0][0];
        P_y[1][1] -= K_y[1] * P_y[0][1];
        
		
		return(angle_y);
	
	//}
	
	};
	
	
	
  };
</script>
</body>
</html>